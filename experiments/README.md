# Reproducibility of the experiments
## Getting Started
### Prerequisites
The following commands or tools need to be installed in advance.
* GNU Time, GNU sed, GNU awk, GNU getopt
* hdfs - hadoop 2.7.0
* scala - version 2.12.15
* java - version 1.8.0_321
* dotnet - 5.0.403
* maven - 3.8.4
* sbt - 1.4.3
* g++-11 - gcc-11.2.0
* psql - postgresql-10.23

### Hareware Requirements
Recommended:
- Processors: 32 threads or above
- Memory: 500 GB or above
- Disk: 5 TB Space, 600 MB read/write speed or above 

### Preparation
#### Attention!
Please execute the following scripts or commands to prepare the environment for the experiment.
The following scripts or commands assume that your current working directory is the **ROOT DIRECTORY** of this project(the same directory as this README file).

#### 1.Prepare graph data

#### 2.Prepare snb data

#### 3.Prepare dbtoaster
1. clone dbtoaster and checkout to commit id 3c62c0c1da9fcbeedfc79fe7969faa24184ae293
2. apply the changes in `dbtoaster_modified` to your local dbtoaster directory(copy and replace)
3. delete the `ddbtoaster/lms/DefaultLMSGen.scala` in your local dbtoaster directory
4. config dbtoaster as described in https://github.com/dbtoaster/dbtoaster-backend/blob/master/README.md
5. add partition info to `src/global/Partitioner.ml` from `dbtoaster_frontend_modified` to your local dbtoaster-a5 directory (copy and replace)
6. `make` your local dbtoaster-a5

#### 4.Configurations
Set the following configuration items to the correct values before running.
* experiment.cfg
    ```shell
        snb.data.base.path=/path/to/snb_data  
        # snb input data should lies under snb_data/${system}/${experiment}/
        data.tools.home=/path/to/data-tools
        # e.g., data.tools.home=/home/data/lab/this-repo/experiments/data-tools
        graph.input.path=/path/to/graph/file
        # e.g., graph.input.path=/home/data/lab/graph
        crown.code.home=/path/to/CROWN
        # e.g., crown.code.home=/home/data/lab/this-repo/crown
        dbtoaster.backend.home=/path/to/dbtoaster-backend
        # e.g., dbtoaster.backend.home=/home/data/lab/dbtoaster
        hdfs.cmd.path=/path/to/hdfs
        # e.g., hdfs.cmd.path=/home/data/continuous/hadoop-2.7.0/bin/hdfs
        hdfs.root.path=hdfs:///path/to/experiment/root
        # e.g., hdfs.root.path=hdfs:///users/lab
    ```
* dbtoaster/src/main/resources/core-site.xml and dbtoaster/src/main/resources/hdfs-site.xml
    ```shell
        mkdir -p dbtoaster/src/main/resources
        # copy the core-site.xml and hdfs-site.xml to these two paths
    ```

#### 5.Check

#### 6.Run experiments

#### 7.Plotting

## Project Structure
```
    ├── build  # build script entry
    ├── execute  # execute script entry
    ├── common.sh  # basic functions for scripts
    ├── data  # store data producing and converting scripts
    │     ├── convert-data.sh
    │     ├── prepare-tools.sh
    │     ├── produce-data.sh
    │     ├── validate-result.sh    
    │     └── tools.cfg
    ├── data-tools  # source code of data producing and converting tools
    │     └── src
    ├── dbtoaster  # dbtoaster executable project folder
    │     ├── ${experiment_name}  # config and query files of specific experiment
    │     │     ├── common.cfg  # filter condition and other common configs
    │     │     ├── func.cfg  # config for func test
    │     │     ├── perf.cfg  # config for perf test
    │     │     └── query.sql
    │     ├── lib  # lib files from compiled dbtoaster-backend
    │     │     └── dbtoaster-*.jar
    │     ├── build.sh  # script to build dbtoaster executable
    │     ├── execute.sh  # script to run dbtoaster executable
    │     ├── experiment.cfg  # basic config for dbtoaster experiments
    │     ├── prepare-data.sh  # convert data to dbtoaster format
    │     ├── prepare-query.sh  # compile sql to scala file by dbtoaster
    │     ├── prepare-system.sh  # compile dbtoaster
    │     └── src
    │           ├── main
    │           │     ├── resources  # config files for HDFS and Spark
    │           │     │     ├── core-site.xml
    │           │     │     ├── hdfs-site.xml
    │           │     │     ├── spark.config.${experiment_name}.func
    │           │     │     ├── spark.config.${experiment_name}.perf
    │           │     └── scala
    │           │         └── experiments
    │           │             └── dbtoaster
    │           │                 ├── Executable.scala
    │           │                 ├── Main.scala  # entry of executable
    │           │                 └── ${experiment_name}
    │           │                       └── query.scala  # generated by prepare-query.sh
    │           └── test
    │               ├── resources  # config files for Func Test
    │               │     └── ${experiment_name}.config.properties
    │               └── scala
    │                   └── experiments
    │                       └── dbtoaster
    │                           └── ${experiment_name}
    │                                 └── FuncTest.scala
    ├── dbtoaster_cpp  # similar to dbtoaster
    ├── flink  # similar to dbtoaster
    ├── crown  # similar to dbtoaster
    └── trill  # similar to dbtoaster
```

## Troubleshooting
If you have any trouble in running these scripts, please check the logs in `log/` or `system/log/`. 
For example, if an error is thrown in running `build -e length3 -s crown`, you can check the log in `crown/log/build.log`.